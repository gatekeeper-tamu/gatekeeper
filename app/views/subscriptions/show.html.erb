<script type="text/javascript">
    function toggleHidden() {
      document.getElementById("hidden_password").parentElement.classList.toggle("hidden");
    }
</script>

<div class="container">
<p id="notice"><%= notice %></p>
</div>

<%= render :layout => 'subscriptions/shared/show' do %>
<div class="row group-show-header">
  <div class="col col-sm-2" align="center">
    <%= button_to 'Back', subscriptions_path, method: :get, class: "sub-header-btn"%>
  </div>
  <div class="col col-sm-8" align="center">
    <h1 class="sub-card-title"><%= @subscription.subscription_name %></h1>
  </div>
  <div class="col col-sm-2" align="center">
    <% if @subscription.can_edit?(current_user) %>
      <%= button_to 'Edit', edit_subscription_path(@subscription), method: :get, class: "sub-header-btn" %>
    <% end %>
  </div>
</div>
<hr>

<p class="subscription-card-title">Name</p>
<p><%= @subscription.subscription_name %></p>

<p class="subscription-card-title">Username</p>
<p><%= @subscription.username %></p>

<p class="subscription-card-title">Password</p>
<p><a id="view-password-button" class="button default ok" onclick=toggleHidden()>    View
  </a>
  <span class="hidden"><input value="<%= @subscription.password %>"  id="hidden_password"/></span>
</p>

<p class="subscription-card-title">Cost per month</p>
<p><%= @subscription.cost_per_month %></p>

<%= button_to 'Visit Service', @subscription.url, method: :get, class: "btn btn-dark" %>
<% if @subscription.user == current_user %>
  <%= button_to 'Delete', @subscription, method: :delete, data: { confirm: 'Are you sure?' }, class: "btn btn-danger card-btn-delete" %> 
<% end %>

<% end %>

<%= render :layout => 'subscriptions/shared/show_no_vines' do %>
  <h2 class="card-title-header">Shared With</h2>
  <hr>
  <% if @subscription.share_records.size <= 0 && (@subscription.user == current_user && @subscription.temp_share_records.size <= 0) %>
      <p style="text-align: center; padding: 10px 30px; ">This subscription is not shared with anyone. Create a group to share this subscription with, add it to one of your current groups, or create a temporary shared link below.</p>
  <% end %>
  <% if @subscription.share_records.size > 0 %>
    <h4 style="margin: 20px 0 0;">Groups</h4>

    <table>
      <tr>
        <th class="shared-header">Group Name</th>
        <th class="shared-header">Owner</th>
        <th class="shared-header">Permission</th>
        <th></th>
      </tr>
      <% @subscription.share_records.each do |share_record| %>
        <tr>
          <% group = Group.find(share_record.group_id) %>
          <td><%= link_to "#{group.group_name}", group_path(group), class: "" %></td>
          <td><%= link_to "#{group.owner.username}", user_root_path(group.owner.username), class: "card-user" %></td>
          <td><%= share_record.permission %></td>
          <td>
            <% if current_user == @subscription.user || current_user.is_admin?(group) %>
              <%= link_to "X", group_path(group, group: { subscription_ids: [@subscription.id], update_action: "remove"}), method: 'patch', class: "card-btn-delete" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </table>
  <% end %>
  <% if @subscription.user == current_user && @subscription.temp_share_records.size > 0 %>
    <h4 style="margin: 20px 0 0;">Temporary Share Links</h4>
    
    
      <% @subscription.temp_share_records.each do |temp_share_record| %>
        <div class="card" style="width: 100%; margin-top: 15px;">
          <div class="card-header text-right">
          <h6 class="card-title" style="font-weight: bold;  margin-bottom: 0; float: left;">
              Created: <%= temp_share_record.created_at.month %>/<%= temp_share_record.created_at.day %>/<%= temp_share_record.created_at.year %> &nbsp | &nbsp
              Expires: <%= temp_share_record.end_date.month %>/<%= temp_share_record.end_date.day %>/<%= temp_share_record.end_date.year %>
            </h6>
            <%= link_to "X", temp_share_record, method: :delete, data: { confirm: 'Are you sure you want to delete this shared subscription (link will no longer be active)?' }, style: "font-weight: bold; text-decoration: none; color: firebrick !important; padding: none;" %>

          </div>
          <div class="card-body">
            <table style="width: 100%; margin-bottom: 0px;">
              <tr>    
                <td style="padding-bottom: 0" ><a href=<%= temp_shared_subscription_url(temp_share_record) %> class="card-user">Link</a></td>
                <td style="padding-bottom: 0">
                    <%= link_to "Extend", edit_temp_shared_subscription_path(temp_share_record), method: :get, class: "card-user" %>
                </td>
                <td style="padding-bottom: 0">
                    <%= link_to "Email", share_temp_shared_subscription_path(temp_share_record), method: :get, class: "card-user" %>
                </td>
              </tr>
            </table>  

          </div>
        </div>
        
      <% end %>
  <% end %>
  <% if @subscription.can_edit?(current_user) %>
    <%= button_to 'Add to Group', edit_subscription_path(@subscription), method: :get, class: "btn btn-dark" %>
  <% end %>
<%= button_to 'Generate Shareable Link', share_subscription_path, method: :get, class: "btn btn-dark" %>
<% end %>

<%= render :layout => 'subscriptions/shared/show_no_vines' do %>

<h2 class="card-title-header">Active Reminders</h2>
<hr>

  <% if @subscription.reminders.count <= 0 %>
    <p style="text-align: center; padding: 10px 30px; ">You currently have no active reminders for this subscription. Create a reminder to be notified about upcomming billing, cancellation, and other notifications</p>
  <% end %>
  <% @subscription.reminders.each do |reminder| %>
    <% if reminder.subscription.subscription_name == @subscription.subscription_name %>
      <div class="card-body">
        <p class="card-text">Reminder type: <%= reminder.reminder_type %></p>
        <p class="card-text">Reminder occurrence: <%= reminder.notification_time %> day before </p>        
        <p class="card-text">End date: <%= reminder.end_date %></p>
        <p class="card-text">Reminder on: <%= reminder.recurring %></p>
        <%= button_to 'Edit Reminder', edit_reminder_path(reminder), method: :get, class: "btn btn-dark btn-view-sub" %>
        <%= button_to 'Delete Reminder', reminder, method: :delete, data: { confirm: 'Are you sure?' } %>

      </div>
    <% else %>
      <p class="card-text">No Reminders</p>
    <% end %>
  <% end %>


<%= button_to 'Create Reminder', new_reminder_path, params: {subscription_id: @subscription},  method: :get, class: "btn btn-dark" %>

<% end %>